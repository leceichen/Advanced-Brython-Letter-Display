<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7x7 Lab - 像素文字生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background-color: #121212;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        h1 {
            font-size: 2.5rem;
            color: #fff;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
        }
        
        .preview-container {
            flex: 2;
            min-width: 400px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #fff;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 1rem;
        }
        
        button {
            background-color: #3a3a3a;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
            margin-top: 5px;
        }
        
        button:hover {
            background-color: #4a4a4a;
        }
        
        .preview-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .font-preview {
            font-family: monospace;
            font-size: 1.5rem;
            line-height: 1.8;
            white-space: pre;
            color: #4CAF50;
            text-align: center;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .char-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            width: auto;
        }
        
        .pixel-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .pixel {
            aspect-ratio: 1;
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .pixel.active {
            background-color: #4CAF50;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        
        .hidden-params {
            display: none;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .control-panel, .preview-container {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>7x7 lab</h1>
        </header>
        
        <div class="main-content">
            <div class="control-panel">
                <h2 class="section-title">控制面板</h2>
                
                <div class="input-group">
                    <label for="textInput">輸入文字 (大寫字母、小寫字母和數字):</label>
                    <input type="text" id="textInput" maxlength="10" placeholder="例如: NFU">
                </div>
                
                <div class="input-group">
                    <label>快速範例:</label>
                    <div class="char-buttons">
                        <button data-char="NFU">NFU</button>
                        <button data-char="ABC">ABC</button>
                        <button data-char="Hello">Hello</button>
                        <button data-char="123">123</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="pixelSize">像素尺寸 (mm):</label>
                    <input type="number" id="pixelSize" value="5.0" min="1" max="20" step="0.5">
                </div>
                
                <div class="input-group">
                    <label for="blockHeight">方塊高度 (mm):</label>
                    <input type="number" id="blockHeight" value="2.0" min="0.5" max="10" step="0.5">
                </div>
                
                <div class="hidden-params">
                    <input type="number" id="printSpeed" value="60">
                    <input type="number" id="nozzleTemp" value="220">
                    <input type="number" id="bedTemp" value="80">
                    <input type="number" id="layerHeight" value="0.2">
                </div>
                
                <div class="action-buttons">
                    <button id="showPreviewBtn">顯示預覽</button>
                    <button id="generateBtn">生成 G-code</button>
                    <button id="copyBtn">複製 G-code</button>
                    <button id="downloadBtn">下載 G-code</button>
                </div>
                
                <div class="input-group" style="margin-top: 20px;">
                    <button id="openEditorBtn">開啟像素編輯器</button>
                </div>
            </div>
            
            <div class="preview-container">
                <h2 class="section-title">字型預覽</h2>
                <div class="preview-area">
                    <div class="font-preview" id="fontPreview">
                        輸入文字以顯示預覽
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 像素編輯器模態視窗 -->
    <div class="modal" id="pixelEditorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="section-title">7x7 像素編輯器</h2>
                <button class="close-modal" id="closeModalBtn">&times;</button>
            </div>
            
            <p style="margin-bottom: 15px; color: #aaa;">點擊像素方塊切換開啟/關閉狀態</p>
            
            <div class="pixel-grid" id="pixelGrid">
                <!-- 像素將由 JavaScript 生成 -->
            </div>
            
            <div class="modal-buttons">
                <button id="savePixelBtn">儲存字元</button>
                <button id="clearPixelBtn">清除畫布</button>
                <button id="closeEditorBtn">關閉編輯器</button>
            </div>
        </div>
    </div>

    <script>
        // 像素網格狀態
        let pixelState = Array(7).fill().map(() => Array(7).fill(false));
        let currentEditingChar = '';
        
        // 字元定義 (7x7 像素)
        const charMap = {
            'A': [
                [0,0,1,1,1,0,0],
                [0,1,0,0,0,1,0],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1]
            ],
            'B': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0]
            ],
            'C': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'D': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0]
            ],
            'E': [
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            'F': [
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            'G': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [1,0,0,1,1,1,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'H': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1]
            ],
            'I': [
                [1,1,1,1,1,1,1],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            'J': [
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'K': [
                [1,0,0,0,0,1,0],
                [1,0,0,0,1,0,0],
                [1,0,0,1,0,0,0],
                [1,1,1,0,0,0,0],
                [1,0,0,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,0,1,0]
            ],
            'L': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            'M': [
                [1,0,0,0,0,0,1],
                [1,1,0,0,0,1,1],
                [1,0,1,0,1,0,1],
                [1,0,0,1,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1]
            ],
            'N': [
                [1,0,0,0,0,0,1],
                [1,1,0,0,0,0,1],
                [1,0,1,0,0,0,1],
                [1,0,0,1,0,0,1],
                [1,0,0,0,1,0,1],
                [1,0,0,0,0,1,1],
                [1,0,0,0,0,0,1]
            ],
            'O': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'P': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            'Q': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,1,0,0,1],
                [1,0,0,0,1,0,1],
                [0,1,1,1,1,1,1]
            ],
            'R': [
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,1,1,1,1,1,0],
                [1,0,0,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,0,1,0]
            ],
            'S': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [0,1,1,1,1,1,0],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'T': [
                [1,1,1,1,1,1,1],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0]
            ],
            'U': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'V': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,0,0,0,1,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0]
            ],
            'W': [
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,1,0,0,1],
                [1,0,1,0,1,0,1],
                [1,1,0,0,0,1,1],
                [1,0,0,0,0,0,1]
            ],
            'X': [
                [1,0,0,0,0,0,1],
                [0,1,0,0,0,1,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,1,0,0],
                [0,1,0,0,0,1,0],
                [1,0,0,0,0,0,1]
            ],
            'Y': [
                [1,0,0,0,0,0,1],
                [0,1,0,0,0,1,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0]
            ],
            'Z': [
                [1,1,1,1,1,1,1],
                [0,0,0,0,0,1,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            '0': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,1,0,1],
                [1,0,0,1,0,0,1],
                [1,0,1,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '1': [
                [0,0,0,1,0,0,0],
                [0,0,1,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,0,0,1,0,0,0],
                [0,1,1,1,1,1,0]
            ],
            '2': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,0,1,1,1,0],
                [0,1,1,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,1]
            ],
            '3': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,0,1,1,1,1,0],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '4': [
                [0,0,0,0,1,0,0],
                [0,0,0,1,1,0,0],
                [0,0,1,0,1,0,0],
                [0,1,0,0,1,0,0],
                [1,1,1,1,1,1,1],
                [0,0,0,0,1,0,0],
                [0,0,0,0,1,0,0]
            ],
            '5': [
                [1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '6': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '7': [
                [1,1,1,1,1,1,1],
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,1,0],
                [0,0,0,0,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0]
            ],
            '8': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            '9': [
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,1],
                [0,0,0,0,0,0,1],
                [1,0,0,0,0,0,1],
                [0,1,1,1,1,1,0]
            ],
            'a': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [0,0,0,0,0,1,0],
                [0,1,1,1,1,1,0],
                [1,0,0,0,0,1,0],
                [0,1,1,1,1,1,0]
            ],
            'b': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,1,1,1,0,0],
                [1,1,0,0,0,1,0],
                [1,0,0,0,0,1,0],
                [1,1,0,0,0,1,0],
                [1,0,1,1,1,0,0]
            ],
            'c': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,1,0],
                [0,1,1,1,1,0,0]
            ],
            'd': [
                [0,0,0,0,0,0,1],
                [0,0,0,0,0,0,1],
                [0,1,1,1,0,0,1],
                [1,0,0,0,1,0,1],
                [1,0,0,0,0,0,1],
                [1,0,0,0,1,0,1],
                [0,1,1,1,0,0,1]
            ],
            'e': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [1,1,1,1,1,1,0],
                [1,0,0,0,0,0,0],
                [0,1,1,1,1,0,0]
            ],
            'f': [
                [0,0,1,1,1,0,0],
                [0,1,0,0,0,1,0],
                [0,1,0,0,0,0,0],
                [1,1,1,1,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0],
                [0,1,0,0,0,0,0]
            ],
            'g': [
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,1,0],
                [0,1,1,1,1,1,0],
                [0,0,0,0,0,1,0],
                [0,1,1,1,1,0,0]
            ],
            'h': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,1,1,1,0,0],
                [1,1,0,0,0,1,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,1,0],
                [1,0,0,0,0,1,0]
            ],
            'i': [
                [0,0,1,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,1,1,0,0,0]
            ],
            'j': [
                [0,0,0,0,1,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,1,1,0,0],
                [0,0,0,0,1,0,0],
                [0,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,0,0,0]
            ],
            'k': [
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,1,0,0,0],
                [1,1,1,0,0,0,0],
                [1,0,0,1,0,0,0],
                [1,0,0,0,1,0,0]
            ],
            'l': [
                [0,1,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,1,1,0,0,0]
            ],
            'm': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,0,1,0,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0]
            ],
            'n': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,1,1,0,0,0],
                [1,1,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0]
            ],
            'o': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,0,0,0]
            ],
            'p': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,0,0,0],
                [1,0,0,0,1,0,0],
                [1,1,1,1,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            'q': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,0,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,1,0,0],
                [0,0,0,0,1,0,0],
                [0,0,0,0,1,0,0]
            ],
            'r': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,1,1,0,0,0],
                [1,1,0,0,1,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0],
                [1,0,0,0,0,0,0]
            ],
            's': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,1,1,1,1,0,0],
                [1,0,0,0,0,0,0],
                [0,1,1,1,0,0,0],
                [0,0,0,0,1,0,0],
                [1,1,1,1,0,0,0]
            ],
            't': [
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,1,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,0,0,0],
                [0,0,1,0,1,0,0],
                [0,0,0,1,0,0,0]
            ],
            'u': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,1,1,0,0],
                [0,1,1,0,1,0,0]
            ],
            'v': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,0,1,0,0,0],
                [0,0,1,0,0,0,0]
            ],
            'w': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [1,0,1,0,1,0,0],
                [1,0,1,0,1,0,0],
                [0,1,0,1,0,0,0]
            ],
            'x': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [0,1,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,1,0,0,0],
                [1,0,0,0,1,0,0]
            ],
            'y': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,0,0,0,1,0,0],
                [1,0,0,0,1,0,0],
                [0,1,1,1,1,0,0],
                [0,0,0,0,1,0,0],
                [0,1,1,1,0,0,0]
            ],
            'z': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [1,1,1,1,1,0,0],
                [0,0,0,1,0,0,0],
                [0,0,1,0,0,0,0],
                [0,1,0,0,0,0,0],
                [1,1,1,1,1,0,0]
            ],
            ' ': [
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0]
            ]
        };

        // 初始化像素網格
        function initPixelGrid() {
            const grid = document.getElementById('pixelGrid');
            grid.innerHTML = '';
            
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const pixel = document.createElement('div');
                    pixel.className = 'pixel';
                    pixel.dataset.row = row;
                    pixel.dataset.col = col;
                    
                    pixel.addEventListener('click', () => {
                        togglePixel(row, col);
                    });
                    
                    grid.appendChild(pixel);
                }
            }
        }

        // 切換像素狀態
        function togglePixel(row, col) {
            pixelState[row][col] = !pixelState[row][col];
            updatePixelDisplay();
        }

        // 更新像素顯示
        function updatePixelDisplay() {
            const pixels = document.querySelectorAll('.pixel');
            
            pixels.forEach(pixel => {
                const row = parseInt(pixel.dataset.row);
                const col = parseInt(pixel.dataset.col);
                
                if (pixelState[row][col]) {
                    pixel.classList.add('active');
                } else {
                    pixel.classList.remove('active');
                }
            });
        }

        // 載入字元到像素網格
        function loadChar(char) {
            if (charMap[char]) {
                for (let row = 0; row < 7; row++) {
                    for (let col = 0; col < 7; col++) {
                        pixelState[row][col] = charMap[char][row][col] === 1;
                    }
                }
                updatePixelDisplay();
            }
        }

        // 顯示字型預覽
        function showFontPreview() {
            const text = document.getElementById('textInput').value;
            const preview = document.getElementById('fontPreview');
            
            if (!text) {
                preview.textContent = "輸入文字以顯示預覽";
                return;
            }
            
            let previewText = '';
            
            for (let row = 0; row < 7; row++) {
                let line = '';
                for (let charIndex = 0; charIndex < text.length; charIndex++) {
                    const char = text[charIndex];
                    if (charMap[char]) {
                        for (let col = 0; col < 7; col++) {
                            line += charMap[char][row][col] === 1 ? '■' : '□';
                        }
                        line += '  '; // 字元間距
                    }
                }
                previewText += line + '\n';
            }
            
            preview.textContent = previewText;
        }

        // 生成 G-code
        function generateGcode() {
            const text = document.getElementById('textInput').value;
            const pixelSize = parseFloat(document.getElementById('pixelSize').value);
            const blockHeight = parseFloat(document.getElementById('blockHeight').value);
            
            // 固定參數
            const printSpeed = 60;
            const nozzleTemp = 220;
            const bedTemp = 80;
            const layerHeight = 0.2;
            const layers = Math.round(blockHeight / layerHeight);
            
            let gcode = `; 像素風格3D列印G-code\n`;
            gcode += `; 文字: ${text}\n`;
            gcode += `; 像素尺寸: ${pixelSize}mm\n`;
            gcode += `; 方塊高度: ${blockHeight}mm\n`;
            gcode += `; 列印速度: ${printSpeed}mm/s\n`;
            gcode += `; 噴頭溫度: ${nozzleTemp}°C\n`;
            gcode += `; 熱床溫度: ${bedTemp}°C\n`;
            gcode += `; 層高: ${layerHeight}mm\n\n`;
            
            // G-code 初始化設定
            gcode += `; 初始化設定\n`;
            gcode += `G21 ; 毫米單位\n`;
            gcode += `G90 ; 絕對座標\n`;
            gcode += `M82 ; 絕對擠出\n\n`;
            
            // 加熱設定
            gcode += `; 加熱設定\n`;
            gcode += `M104 S${nozzleTemp} ; 設定噴頭溫度\n`;
            gcode += `M140 S${bedTemp} ; 設定熱床溫度\n\n`;
            
            // 等待加熱
            gcode += `; 等待加熱\n`;
            gcode += `M190 S${bedTemp} ; 等待熱床達到溫度\n`;
            gcode += `M109 S${nozzleTemp} ; 等待噴頭達到溫度\n\n`;
            
            // 初始移動
            gcode += `; 初始移動\n`;
            gcode += `G28 ; 所有軸歸零\n`;
            gcode += `G1 Z5 F3000 ; 抬升噴頭\n\n`;
            
            // 開始列印像素方塊
            gcode += `; 開始列印像素方塊\n`;
            gcode += `; 總層數: ${layers}\n\n`;
            
            // 生成每個字元的像素位置
            let xOffset = 10;
            
            for (let charIndex = 0; charIndex < text.length; charIndex++) {
                const char = text[charIndex];
                
                if (charMap[char]) {
                    // 計算字元位置
                    const charX = xOffset;
                    
                    // 生成每個像素方塊
                    for (let row = 0; row < 7; row++) {
                        for (let col = 0; col < 7; col++) {
                            if (charMap[char][row][col] === 1) {
                                const x = charX + col * pixelSize;
                                const y = 10 + row * pixelSize;
                                
                                // 為每個方塊生成所有層
                                for (let layer = 1; layer <= layers; layer++) {
                                    const z = layer * layerHeight;
                                    
                                    gcode += `; 第 ${layer} 層, Z=${z.toFixed(2)}mm\n`;
                                    gcode += `G1 Z${z.toFixed(2)} F3000\n`;
                                    gcode += `G1 X${x.toFixed(2)} Y${y.toFixed(2)} F3000\n`;
                                    gcode += `G1 E0.4 F300 ; 開始擠出\n`;
                                    
                                    // 繪製方塊輪廓
                                    gcode += `G1 X${(x + pixelSize).toFixed(2)} Y${y.toFixed(2)} E0.8 F${printSpeed}\n`;
                                    gcode += `G1 X${(x + pixelSize).toFixed(2)} Y${(y + pixelSize).toFixed(2)} E0.8\n`;
                                    gcode += `G1 X${x.toFixed(2)} Y${(y + pixelSize).toFixed(2)} E0.8\n`;
                                    gcode += `G1 X${x.toFixed(2)} Y${y.toFixed(2)} E0.8\n`;
                                    
                                    gcode += `G1 E-0.4 F1800 ; 回抽\n\n`;
                                }
                            }
                        }
                    }
                    
                    xOffset += 8 * pixelSize; // 字元間距
                }
            }
            
            // 列印完成
            gcode += `; 列印完成\n`;
            gcode += `G1 Z10 F3000 ; 抬升噴頭\n`;
            gcode += `M104 S0 ; 關閉噴頭加熱\n`;
            gcode += `M140 S0 ; 關閉熱床加熱\n`;
            gcode += `G28 X Y ; X/Y軸歸零\n`;
            gcode += `M84 ; 關閉步進馬達\n`;
            gcode += `M30 ; 程式結束\n`;
            
            return gcode;
        }

        // 複製 G-code 到剪貼簿
        function copyGcode() {
            const gcode = generateGcode();
            if (!gcode.includes('開始列印像素方塊')) {
                alert('請先生成有效的 G-code！');
                return;
            }
            
            navigator.clipboard.writeText(gcode).then(() => {
                alert('G-code 已複製到剪貼簿！');
            }).catch(err => {
                console.error('複製失敗: ', err);
                alert('複製失敗，請手動複製文字');
            });
        }

        // 下載 G-code 檔案
        function downloadGcode() {
            const gcode = generateGcode();
            if (!gcode.includes('開始列印像素方塊')) {
                alert('請先生成有效的 G-code！');
                return;
            }
            
            const text = document.getElementById('textInput').value || 'pixel_text';
            const blob = new Blob([gcode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${text}.gcode`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 清除像素畫布
        function clearPixelCanvas() {
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    pixelState[row][col] = false;
                }
            }
            updatePixelDisplay();
        }

        // 開啟像素編輯器
        function openPixelEditor() {
            const modal = document.getElementById('pixelEditorModal');
            modal.style.display = 'flex';
            clearPixelCanvas();
            currentEditingChar = '';
        }

        // 關閉像素編輯器
        function closePixelEditor() {
            const modal = document.getElementById('pixelEditorModal');
            modal.style.display = 'none';
        }

        // 儲存自訂字元
        function saveCustomChar() {
            const char = prompt('請輸入要儲存的字元 (單一字元):');
            if (char && char.length === 1) {
                charMap[char] = JSON.parse(JSON.stringify(pixelState));
                alert(`字元 '${char}' 已儲存！`);
                currentEditingChar = char;
            } else {
                alert('請輸入有效的單一字元！');
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initPixelGrid();
            
            // 事件監聽器
            document.getElementById('showPreviewBtn').addEventListener('click', showFontPreview);
            document.getElementById('generateBtn').addEventListener('click', () => {
                const gcode = generateGcode();
                if (gcode.includes('開始列印像素方塊')) {
                    alert('G-code 生成成功！請使用複製或下載功能');
                } else {
                    alert('請輸入有效的文字！');
                }
            });
            document.getElementById('copyBtn').addEventListener('click', copyGcode);
            document.getElementById('downloadBtn').addEventListener('click', downloadGcode);
            
            // 快速範例按鈕
            document.querySelectorAll('.char-buttons button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const char = e.target.dataset.char;
                    document.getElementById('textInput').value = char;
                    showFontPreview();
                });
            });
            
            // 文字輸入變化時更新預覽
            document.getElementById('textInput').addEventListener('input', showFontPreview);
            
            // 像素編輯器相關事件
            document.getElementById('openEditorBtn').addEventListener('click', openPixelEditor);
            document.getElementById('closeModalBtn').addEventListener('click', closePixelEditor);
            document.getElementById('closeEditorBtn').addEventListener('click', closePixelEditor);
            document.getElementById('savePixelBtn').addEventListener('click', saveCustomChar);
            document.getElementById('clearPixelBtn').addEventListener('click', clearPixelCanvas);
            
            // 點擊模態視窗外部關閉
            document.getElementById('pixelEditorModal').addEventListener('click', (e) => {
                if (e.target.id === 'pixelEditorModal') {
                    closePixelEditor();
                }
            });
            
            // 初始顯示預覽
            showFontPreview();
        });
    </script>
</body>
</html>
